// KV-Keeper.js by andre487, see https://clck.ru/9cB92
!function(e,n){"use strict";function t(){v.dbVersion=1,v.dbName="kv-keeper-items",v.storeName="items",v.defaultType=y,v.namespace=r()}function r(){return v.dbName+":"+v.storeName+":"}function o(e){if([p,g,y].indexOf(e)==-1)throw new Error(w+"Invalid type "+e)}function u(e){return function(n,t){if(n)for(var r=0;r<N.length;r++)N[r](n);return e(n,t)}}function i(e){switch(e){case y:return a();case g:return c(g,S.create());case p:return c(p,k.create())}return null}function c(e,n){return{type:e,instance:n}}function a(){var e=E.db;return e?c(g,e):(e="undefined"!=typeof S&&S.create())?c(g,e):(e=E.ls,e?c(p,e):"undefined"!=typeof k?c(g,k.create()):void 0)}function f(e,n){n=u(n);var t=e.open(v.dbName,v.dbVersion);t.onsuccess=function(){var e=t.result;e.onversionchange=function(){e.close()},n(null,e)},t.onerror=function(e){var t=new Error(w+"DB open request error");t.event=e,n(t)},t.onupgradeneeded=function(){S.setupSchema(t.result)},t.onblocked=function(e){var t=new Error(w+"DB is blocked");t.event=e,n(t)}}function s(e,n){e.onsuccess=function(e){n(null,e)},e.onerror=function(t){var r=e.error.message||"Unknown error ",o=new Error(w+"DB request error: "+r);o.event=t,n(o)}}function l(e){return function(n,t){n?e(n):e(null,t.target.result)}}var v,d=["setItem","getItem","removeItem","getKeys","getLength","clear"],m=["dbName","storeName","defaultType"],g="db",p="ls",y="auto",h="readwrite",b="readonly",w="[kv-keeper] ",I=Object.keys,E={},N=[];n?v=n:e.KvKeeper=v={},t(),v.addErrorListener=function(e){if("function"!=typeof e)throw new Error("Listener must be a function");N.push(e)},v.removeErrorListener=function(e){var n=N.indexOf(e);n>-1&&N.splice(n,1)},v.getErrorListeners=function(){return N},v.removeAllErrorListeners=function(){N=[]},v.configure=function(e){if(v.__configured)throw new Error(w+"Configuration can be set only once");v.__configured=!0,"defaultType"in e&&o(e.defaultType),I(e).forEach(function(n){if(!(m.indexOf(n)>-1))throw t(),new Error(w+n+" is not configurable");v[n]=e[n]}),v.namespace=r()},v.getStorage=function(e,n){"function"==typeof e&&(n=e,e=null),n=u(n),e=e||v.defaultType,o(e);var t=v._getInstance(e);if(t)t.init(n);else{var r=e==y?"No supported stores":'No "'+e+'" store support';n(new Error(w+r))}},v._getInstance=function(e){var n=E[e];if(!n){var t=i(e);n=E[t.type]=t.instance}return n},d.forEach(function(e){v[e]=function(){var n=arguments;v.getStorage(function(t,r){if(t){var o=n[n.length-1];return o(t)}r[e].apply(r,n)})}});var k=v.StorageLS=function(e){var n=this;n.init=function(e){e(null,n)},n.setItem=function(n,t,r){r=u(r);try{e.setItem(k.createKey(n),t),r(null)}catch(e){r(e)}},n.getItem=function(n,t){t(null,e.getItem(k.createKey(n)))},n.removeItem=function(n,t){e.removeItem(k.createKey(n)),t(null)},n.getKeys=function(n){for(var t=I(e),r=v.namespace.length,o=[],u=0;u<t.length;u++){var i=t[u];K(i)&&o.push(i.slice(r))}n(null,o)},n.getLength=function(n){n(null,I(e).filter(K).length)},n.clear=function(n){I(e).filter(K).forEach(e.removeItem,e),n(null)},n.close=function(){E.ls=null}};k.createKey=function(e){return v.namespace+e};var K=k.isKeeperKey=function(e){return 0==e.indexOf(v.namespace)};k.create=function(){var n=e.localStorage;return n?new k(n):null};var S=v.StorageDB=function(e){function n(e){return t.transaction([v.storeName],e).objectStore(v.storeName)}var t,r=this;r.init=function(n){n=u(n),f(e,function(e,o){return e?n(e):(t=o,void n(null,r))})},r.close=function(){t.close(),E.db=null},r.setItem=function(e,t,r){r=u(r),s(n(h).put({key:e,value:String(t)}),l(r))},r.getItem=function(e,t){t=u(t),s(n(b).get(e),function(e,n){if(e)return t(e);var r=n.target.result;t(null,r?r.value:null)})},r.removeItem=function(e,t){t=u(t),s(n(h).delete(e),l(function(e,n){setTimeout(t.bind(null,e,n),0)}))},r.getKeys=function(e){e=u(e);var t=[];s(n(b).openCursor(),function(n,r){if(n)return e(n);var o=r.target.result;return o?(t.push(o.key),o.continue()):void e(null,t)})},r.getLength=function(e){e=u(e),s(n(b).count(),l(e))},r.clear=function(e){e=u(e),s(n(h).clear(),l(e))}};S.create=function(){var n=e.indexedDB;return n&&n.open&&e.IDBKeyRange?new S(n):null},S.setupSchema=function(e){e.objectStoreNames.contains(v.storeName)||e.createObjectStore(v.storeName,{keyPath:"key"})}}(self,"undefined"!=typeof exports&&exports);
//# sourceMappingURL=kv-keeper.map