// KV-Keeper.js by andre487, see https://clck.ru/9cB92
!function(e){"use strict";function n(){}function t(){h.dbVersion=1,h.dbName="kv-keeper-items",h.storeName="items",h.defaultType="auto",h.namespace=r()}function r(){return h.dbName+":"+h.storeName+":"}function o(e){if(["ls","db","auto"].indexOf(e)==-1)throw new Error(m+"Invalid type "+e)}function u(e){var t=e||n;return function(e,n){if(e)for(var r=0;r<y.length;r++)y[r](e);return t(e,n)}}function i(e){switch(e){case"auto":return c();case"db":return a("db",E.create());case"ls":return a("ls",w.create())}return null}function a(e,n){return{type:e,instance:n}}function c(){var e=p.db;return e?a("db",e):(e=void 0!==E&&E.create())?a("db",e):(e=p.ls,e?a("ls",e):void 0!==w?a("ls",w.create()):void 0)}function f(e,n){var t=u(n),r=e.open(h.dbName,h.dbVersion);r.onsuccess=function(){var e=r.result;e.onversionchange=function(){e.close()},t(null,e)},r.onerror=function(e){var n=new Error(m+"DB open request error");n.event=e,t(n)},r.onupgradeneeded=function(){E.setupSchema(r.result)},r.onblocked=function(e){var n=new Error(m+"DB is blocked");n.event=e,t(n)}}function l(e,n){e.onsuccess=function(e){n(null,e)},e.onerror=function(t){var r=e.error.message||"Unknown error ",o=new Error(m+"DB request error: "+r);o.event=t,n(o)}}function s(e){return function(n,t){n?e(n):e(null,t.target.result)}}var v=["setItem","getItem","hasItem","removeItem","getKeys","getLength","clear"],d=["dbName","storeName","defaultType"],m="[kv-keeper] ",g=Object.keys,p={},y=[],h={},b=!0;"object"==typeof exports&&(exports=h,b=!1),e.modules&&modules.define&&modules.require&&(modules.define("kv-keeper",function(e){e(h)}),b=!1),b&&(e.KvKeeper=h),t(),h.preconnect=function(){h.getStorage(n)},h.addErrorListener=function(e){if("function"!=typeof e)throw new Error("Listener must be a function");y.push(e)},h.removeErrorListener=function(e){var n=y.indexOf(e);n>-1&&y.splice(n,1)},h.getErrorListeners=function(){return y},h.removeAllErrorListeners=function(){y=[]},h.configure=function(e){if(h.__configured)throw new Error(m+"Configuration can be set only once");h.__configured=!0,"defaultType"in e&&o(e.defaultType);for(var n in e)if(e.hasOwnProperty(n)){if(!(d.indexOf(n)>-1))throw t(),new Error(m+n+" is not configurable");h[n]=e[n]}h.namespace=r()},h.getStorage=function(e,n){var t=e,r=n;"function"==typeof t&&(r=e,t=null),r=u(r),t=t||h.defaultType,o(t),h._getInstance(t,r)},h._getInstance=function(e,n){var t=p[e];if(t)return n(null,t);var r=m+("auto"==e?"No supported storages":'No "'+e+'" storage support');if(null===t)return n(new Error(r));var o=i(e);if(!o||!o.instance)return n(new Error(r));t=p[e]=o.instance,t.init(n)},v.forEach(function(e){h[e]=function(){for(var t=[],r=0;r<arguments.length;r++)t.push(arguments[r]);h.getStorage(function(r,o){if(r){return(t.filter(function(e){return"function"==typeof e})[0]||n)(r)}o[e].apply(o,t)})}});var w=h.StorageLS=function(e){var t=this;t.init=function(e){e(null,t)},t.setItem=function(n,t,r){var o=u(r);try{e.setItem(w.createKey(n),t),o(null)}catch(e){o(e)}},t.getItem=function(n,t){t(null,e.getItem(w.createKey(n)))},t.hasItem=function(n,t){t(null,null!==e.getItem(w.createKey(n)))},t.removeItem=function(t,r){var o=r||n;e.removeItem(w.createKey(t)),o(null)},t.getKeys=function(n){for(var t=g(e),r=h.namespace.length,o=[],u=0;u<t.length;u++){var i=t[u];I(i)&&o.push(i.slice(r))}n(null,o)},t.getLength=function(n){n(null,g(e).filter(I).length)},t.clear=function(n){g(e).filter(I).forEach(e.removeItem,e),n(null)},t.close=function(){delete p.ls,delete p.auto}};w.createKey=function(e){return h.namespace+e};var I=w.isKeeperKey=function(e){return 0==e.indexOf(h.namespace)};w.create=function(){var n;try{n=e.localStorage}catch(e){}return n?new w(n):null};var E=h.StorageDB=function(e){function n(e){return t.transaction([h.storeName],e).objectStore(h.storeName)}var t,r=this;r.init=function(n){var o=u(n);f(e,function(e,n){if(e)return o(e);t=n,o(null,r)})},r.close=function(){t&&t.close(),delete p.db,delete p.auto},r.setItem=function(e,t,r){var o=u(r);l(n("readwrite").put({key:e,value:String(t)}),s(o))},r.getItem=function(e,t){var r=u(t);l(n("readonly").get(e),function(e,n){if(e)return r(e);var t=n.target.result;r(null,t?t.value:null)})},r.hasItem=function(e,t){var r=u(t);l(n("readonly").get(e),function(e,n){if(e)return r(e);r(null,Boolean(n.target.result))})},r.removeItem=function(e,t){var r=u(t);l(n("readwrite").delete(e),s(function(e,n){setTimeout(r.bind(null,e,n),0)}))},r.getKeys=function(e){var t=u(e),r=[];l(n("readonly").openCursor(),function(e,n){if(e)return t(e);var o=n.target.result;if(o)return r.push(o.key),o.continue();t(null,r)})},r.getLength=function(e){var t=u(e);l(n("readonly").count(),s(t))},r.clear=function(e){var t=u(e);l(n("readwrite").clear(),s(t))}};E.create=function(){var n=e.indexedDB;return n&&n.open&&e.IDBKeyRange?new E(n):null},E.setupSchema=function(e){e.objectStoreNames.contains(h.storeName)||e.createObjectStore(h.storeName,{keyPath:"key"})}}(self);
//# sourceMappingURL=kv-keeper.map