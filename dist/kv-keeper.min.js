// KV-Keeper.js by andre487, see https://clck.ru/9cB92
!function(s,h){"use strict";function I(){e.dbVersion=1,e.dbName="kv-keeper-items",e.storeName="items",e.defaultType=d,e.namespace=w()}function w(){return e.dbName+":"+e.storeName+":"}function b(e){if(-1==[m,f,d].indexOf(e))throw new Error(u+"Invalid type "+e)}function t(e){return function(n,r){if(n)for(var t=0;t<o.length;t++)o[t](n);return e(n,r)}}function E(e){switch(e){case d:return N();case f:return i(f,r.create());case m:return i(m,n.create())}return null}function i(e,n){return{type:e,instance:n}}function N(){var e=c.db;return e?i(f,e):(e="undefined"!=typeof r&&r.create())?i(f,e):(e=c.ls,e?i(m,e):"undefined"!=typeof n?i(f,n.create()):void 0)}function K(c,o){o=t(o);var n=c.open(e.dbName,e.dbVersion);n.onsuccess=function(){var e=n.result;e.onversionchange=function(){e.close()},o(null,e)},n.onerror=function(n){var e=new Error(u+"DB open request error");e.event=n,o(e)},n.onupgradeneeded=function(){r.setupSchema(n.result)},n.onblocked=function(n){var e=new Error(u+"DB is blocked");e.event=n,o(e)}}function a(e,n){e.onsuccess=function(e){n(null,e)},e.onerror=function(r){var o=e.error.message||"Unknown error ",t=new Error(u+"DB request error: "+o);t.event=r,n(t)}}function l(e){return function(n,t){n?e(n):e(null,t.target.result)}}var e,S=["setItem","getItem","removeItem","getKeys","getLength","clear"],k=["dbName","storeName","defaultType"],f="db",m="ls",d="auto",p="readwrite",g="readonly",u="[kv-keeper] ",v=Object.keys,c={},o=[];h?e=h:s.KvKeeper=e={},I(),e.addErrorListener=function(e){if("function"!=typeof e)throw new Error("Listener must be a function");o.push(e)},e.removeErrorListener=function(n){var e=o.indexOf(n);e>-1&&o.splice(e,1)},e.getErrorListeners=function(){return o},e.removeAllErrorListeners=function(){o=[]},e.configure=function(n){if(e.__configured)throw new Error(u+"Configuration can be set only once");e.__configured=!0,"defaultType"in n&&b(n.defaultType),v(n).forEach(function(t){if(!(k.indexOf(t)>-1))throw I(),new Error(u+t+" is not configurable");e[t]=n[t]}),e.namespace=w()},e.getStorage=function(n,r){"function"==typeof n&&(r=n,n=null),r=t(r),n=n||e.defaultType,b(n);var o=e._getInstance(n);if(o)o.init(r);else{var c=n==d?"No supported stores":'No "'+n+'" store support';r(new Error(u+c))}},e._getInstance=function(n){var e=c[n];if(!e){var t=E(n);e=c[t.type]=t.instance}return e},S.forEach(function(n){e[n]=function(){var t=arguments;e.getStorage(function(e,r){if(e){var o=t[t.length-1];return o(e)}r[n].apply(r,t)})}});var n=e.StorageLS=function(o){var r=this;r.init=function(e){e(null,r)},r.setItem=function(r,u,e){e=t(e);try{o.setItem(n.createKey(r),u),e(null)}catch(n){e(n)}},r.getItem=function(e,t){t(null,o.getItem(n.createKey(e)))},r.removeItem=function(e,t){o.removeItem(n.createKey(e)),t(null)},r.getKeys=function(c){for(var t=v(o),i=new RegExp("^"+e.namespace),r=[],n=0;n<t.length;n++){var u=t[n];y(u)&&r.push(u.replace(i,""))}c(null,r)},r.getLength=function(e){e(null,v(o).filter(y).length)},r.clear=function(e){v(o).filter(y).forEach(o.removeItem,o),e(null)},r.close=function(){c.ls=null}};n.createKey=function(n){return e.namespace+n};var y=n.isKeeperKey=function(n){return 0==n.indexOf(e.namespace)};n.create=function(){var e=s.localStorage;return e?new n(e):null};var r=e.StorageDB=function(u){function r(n){return o.transaction([e.storeName],n).objectStore(e.storeName)}var o,n=this;n.init=function(e){e=t(e),K(u,function(t,r){return t?e(t):(o=r,void e(null,n))})},n.close=function(){o.close(),c.db=null},n.setItem=function(n,o,e){e=t(e),a(r(p).put({key:n,value:String(o)}),l(e))},n.getItem=function(n,e){e=t(e),a(r(g).get(n),function(n,r){if(n)return e(n);var t=r.target.result;e(null,t?t.value:null)})},n.removeItem=function(n,e){e=t(e),a(r(p).delete(n),l(function(n,t){setTimeout(e.bind(null,n,t),0)}))},n.getKeys=function(e){e=t(e);var n=[];a(r(g).openCursor(),function(r,o){if(r)return e(r);var t=o.target.result;return t?(n.push(t.key),t.continue()):void e(null,n)})},n.getLength=function(e){e=t(e),a(r(g).count(),l(e))},n.clear=function(e){e=t(e),a(r(p).clear(),l(e))}};r.create=function(){var e=s.indexedDB;return e&&e.open&&s.IDBKeyRange?new r(e):null},r.setupSchema=function(n){n.objectStoreNames.contains(e.storeName)||n.createObjectStore(e.storeName,{keyPath:"key"})}}(self,"undefined"!=typeof exports&&exports);
//# sourceMappingURL=kv-keeper.map