// Key-Value Keeper by andre487, see https://clck.ru/9cB92
(function(e,t){"use strict";var n={};var r={};if(typeof e!=="undefined"){r=e}o();function o(){r.dbVersion=1;r.dbName="kv-keeper-items";r.storeName="items";r.namespace=i()}function i(){return r.dbName+":"+r.storeName+":"}r.configurable=["dbName","storeName"];r.configure=function(e){if(r.__configured){throw new Error("[kv-keeper] Configuration can be set only once")}r.__configured=true;Object.keys(e).forEach(function(t){if(r.configurable.indexOf(t)>-1){r[t]=e[t]}else{o();throw new Error("[kv-keeper] Option "+t+" is not configurable")}});r.namespace=i()};r.getStorage=function(e,t){if(typeof e==="function"){t=e;e=null}e=e||"auto";var n=r._getInstance(e);if(n){n.init(t)}else{var o=e==="auto"?"This platform does not support any storages":'Storage with type "'+e+'" is not supported';t(new Error("[kv-keeper] "+o))}};r._getInstance=function(e){var t=n[e];if(!t){var r=u(e);t=n[r.type]=r.instance}return t};function u(e){switch(e){case"auto":return a();case"db":return{type:"db",instance:f.create()};case"ls":return{type:"ls",instance:s.create()}}return null}function a(){var e=n.db;if(e){return{type:"db",instance:e}}e=f.create();if(e){return{type:"db",instance:e}}e=n.ls;if(e){return{type:"ls",instance:e}}return{type:"ls",instance:s.create()}}var c=["setItem","getItem","hasItem","removeItem","getKeys","getLength","clear"];c.forEach(function(e){r[e]=function(){var t=[];[].push.apply(t,arguments);r.getStorage(function(n,r){if(n){var o=t[t.length-1];return o(n)}r[e].apply(r,t)})}});var s=r.StorageLS=function(e){var t=this;this.init=function(e){e(null,t)};this.setItem=function(t,n,r){t=s.createKey(t);try{e.setItem(t,n);r&&r(null)}catch(e){r&&r(e)}};this.getItem=function(t,n){t=s.createKey(t);n(null,e.getItem(t))};this.hasItem=function(t,n){t=s.createKey(t);n(null,e[t]!==undefined)};this.removeItem=function(t,n){t=s.createKey(t);e.removeItem(t);n&&n(null)};this.getKeys=function(t){var n=Object.keys(e).filter(s.isKeeperKey);t(null,n)};this.getLength=function(t){t(null,e.length)};this.clear=function(t){e.clear();t&&t(null)};this.close=function(){n.ls=null}};s.createKey=function(e){return r.namespace+e};s.isKeeperKey=function(e){return e.indexOf(r.namespace)===0};s.create=function(){var e=window.localStorage;return e?new s(e):null};var f=r.StorageDB=function(e){var t=this;this.init=function(n){l(e,function(e,r){if(e){return n(e)}t._db=r;n(null,t)})};this.close=function(){t._db.close();n.db=null};this.setItem=function(e,t,n){var r=o("readwrite").put({key:e,value:t});v(r,p(n))};this.getItem=function(e,t){var n=o("readonly").get(e);v(n,p(t,"target.result.value"))};this.hasItem=function(e,t){var n=o("readonly").openCursor(e);v(n,function(e,n){if(e){return t(e)}t(null,Boolean(n.target.result))})};this.removeItem=function(e,t){var n=o("readwrite").delete(e);function r(){var e=arguments;setTimeout(function(){t.apply(null,e)},0)}v(n,p(r))};this.getKeys=function(e){var t=o("readonly").openCursor();var n=[];v(t,function(t,r){if(t){return e(t)}var o=r.target.result;if(o){n.push(o.key);return o.continue()}e(null,n)})};this.getLength=function(e){var t=o("readonly").count();v(t,p(e,"target.result"))};this.clear=function(e){var t=o("readwrite").clear();v(t,p(e))};function o(e){return t._db.transaction([r.storeName],e).objectStore(r.storeName)}};f.create=function(){var e=window.indexedDB;return e?new f(e):null};f.setupSchema=function(e){try{e.createObjectStore(r.storeName,{keyPath:"key"})}catch(e){if(e.name!=="ConstraintError"){throw e}console.warn("[kv-keeper] data store already exists")}};function l(e,t){var n=e.open(r.dbName,r.dbVersion);n.onsuccess=function(e){var n=e.target.result;n.onversionchange=function(){n.close()};t(null,n)};n.onerror=function(e){var n=new Error("[kv-keeper] DB request error");n.event=e;t(n)};n.onupgradeneeded=function(e){f.setupSchema(e.target.result)};n.onblocked=function(e){var n=new Error("[kv-keeper] DB is blocked");n.event=e;t(n)}}function v(e,t){e.onsuccess=function(e){t(null,e)};e.onerror=function(e){var n=new Error("[kv-keeper] DB request error");n.event=e;t(n)}}function p(e,t){if(!e){return function(){}}return function(n,r){if(n){return e(n)}if(typeof t==="undefined"){return e(null)}var o=t.split(".");var i=r;for(var u=0;u<o.length;u++){if(!(o[u]in i)){i=null;break}i=i[o[u]]}e(null,i)}}t["KvKeeper"]=e})({},function(){return this}());
//# sourceMappingURL=kv-keeper.map