// Key-Value Keeper by andre487, see https://clck.ru/9cB92
!function(s,g){function d(){e.dbVersion=1,e.dbName="kv-keeper-items",e.storeName="items",e.defaultType=l,e.namespace=m()}function m(){return e.dbName+":"+e.storeName+":"}function p(e){if(-1==k.indexOf(e))throw new Error("[kv-keeper] Invalid type "+e)}function I(e){switch(e){case l:return w();case o:return a(o,u.create());case f:return a(f,n.create())}return null}function a(e,n){return{type:e,instance:n}}function w(){var e=r.db;return e?a(o,e):(e=u.create())?a(o,e):(e=r.ls,e?a(f,e):a(o,n.create()))}function y(r,t){var n=r.open(e.dbName,e.dbVersion);n.onsuccess=function(n){var e=n.target.result;e.onversionchange=function(){e.close()},t(null,e)},n.onerror=function(n){var e=new Error("[kv-keeper] DB request error");e.event=n,t(e)},n.onupgradeneeded=function(e){u.setupSchema(e.target.result)},n.onblocked=function(n){var e=new Error("[kv-keeper] DB is blocked");e.event=n,t(e)}}function t(e,n){e.onsuccess=function(e){n(null,e)},e.onerror=function(t){var e=new Error("[kv-keeper] DB request error");e.event=t,n(e)}}function c(e,n){return e?function(u,a){if(u)return e(u);if(n===g)return e(null);for(var o=n.split("."),t=a,r=0;r<o.length;r++){if(!(o[r]in t)){t=null;break}t=t[o[r]]}e(null,t)}:function(){}}var e,v="readwrite",i="readonly",l="auto",o="db",f="ls",r={};"undefined"!=typeof exports?e=exports:s.KvKeeper=e={},d();var h=["dbName","storeName","defaultType"];e.configure=function(n){if(e.__configured)throw new Error("[kv-keeper] Configuration can be set only once");e.__configured=!0,"defaultType"in n&&p(n.defaultType),Object.keys(n).forEach(function(t){if(!(h.indexOf(t)>-1))throw d(),new Error("[kv-keeper] Option "+t+" is not configurable");e[t]=n[t]}),e.namespace=m()};var k=[f,o,l];e.getStorage=function(n,t){"function"==typeof n&&(t=n,n=null),n=n||e.defaultType,p(n);var r=e._getInstance(n);if(r)r.init(t);else{var o=n==l?"This platform does not support any storages":'Storage with type "'+n+'" is not supported';t(new Error("[kv-keeper] "+o))}},e._getInstance=function(n){var e=r[n];if(!e){var t=I(n);e=r[t.type]=t.instance}return e};var b=["setItem","getItem","hasItem","removeItem","getKeys","getLength","clear"];b.forEach(function(n){e[n]=function(){var t=[];[].push.apply(t,arguments),e.getStorage(function(e,r){if(e){var o=t[t.length-1];return o(e)}r[n].apply(r,t)})}});var n=e.StorageLS=function(t){var e=this;e.init=function(n){n(null,e)},e.setItem=function(e,o,r){e=n.createKey(e);try{t.setItem(e,o),r(null)}catch(e){r(e)}},e.getItem=function(e,r){e=n.createKey(e),r(null,t.getItem(e))},e.hasItem=function(e,r){e=n.createKey(e),r(null,t[e]!==g)},e.removeItem=function(e,r){e=n.createKey(e),t.removeItem(e),r(null)},e.getKeys=function(e){var r=Object.keys(t).filter(n.isKeeperKey);e(null,r)},e.getLength=function(e){e(null,t.length)},e.clear=function(e){t.clear(),e(null)},e.close=function(){r.ls=null}};n.createKey=function(n){return e.namespace+n},n.isKeeperKey=function(n){return 0==n.indexOf(e.namespace)},n.create=function(){var e=s.localStorage;return e?new n(e):null};var u=e.StorageDB=function(a){function o(n){return u.transaction([e.storeName],n).objectStore(e.storeName)}var u,n=this;n.init=function(e){y(a,function(t,r){return t?e(t):(u=r,void e(null,n))})},n.close=function(){u.close(),r.db=null},n.setItem=function(e,n,r){var u=o(v).put({key:e,value:n});t(u,c(r))},n.getItem=function(e,n){var r=o(i).get(e);t(r,c(n,"target.result.value"))},n.hasItem=function(n,e){var r=o(i).openCursor(n);t(r,function(n,t){return n?e(n):void e(null,Boolean(t.target.result))})},n.removeItem=function(e,n){function r(){var e=arguments;setTimeout(function(){n.apply(null,e)},0)}var u=o(v).delete(e);t(u,c(r))},n.getKeys=function(e){var r=o(i).openCursor(),n=[];t(r,function(r,o){if(r)return e(r);var t=o.target.result;return t?(n.push(t.key),t.continue()):void e(null,n)})},n.getLength=function(e){var n=o(i).count();t(n,c(e,"target.result"))},n.clear=function(e){var n=o(v).clear();t(n,c(e))}};u.create=function(){var e=s.indexedDB;return e?new u(e):null},u.setupSchema=function(n){try{n.createObjectStore(e.storeName,{keyPath:"key"})}catch(e){if("ConstraintError"!==e.name)throw e;console.warn("[kv-keeper] data store already exists")}}}(self);
//# sourceMappingURL=kv-keeper.map