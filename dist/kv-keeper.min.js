// KV-Keeper.js by andre487, see https://clck.ru/9cB92
!function(e,n){"use strict";function t(){}function r(){d.dbVersion=1,d.dbName="kv-keeper-items",d.storeName="items",d.defaultType=h,d.namespace=o()}function o(){return d.dbName+":"+d.storeName+":"}function u(e){if([y,p,h].indexOf(e)==-1)throw new Error(w+"Invalid type "+e)}function i(e){var n=e||t;return function(e,t){if(e)for(var r=0;r<K.length;r++)K[r](e);return n(e,t)}}function a(e){switch(e){case h:return f();case p:return c(p,L.create());case y:return c(y,S.create())}return null}function c(e,n){return{type:e,instance:n}}function f(){var e=N.db;return e?c(p,e):(e="undefined"!=typeof L&&L.create())?c(p,e):(e=N.ls,e?c(y,e):"undefined"!=typeof S?c(y,S.create()):void 0)}function l(e,n){var t=i(n),r=e.open(d.dbName,d.dbVersion);r.onsuccess=function(){var e=r.result;e.onversionchange=function(){e.close()},t(null,e)},r.onerror=function(e){var n=new Error(w+"DB open request error");n.event=e,t(n)},r.onupgradeneeded=function(){L.setupSchema(r.result)},r.onblocked=function(e){var n=new Error(w+"DB is blocked");n.event=e,t(n)}}function s(e,n){e.onsuccess=function(e){n(null,e)},e.onerror=function(t){var r=e.error.message||"Unknown error ",o=new Error(w+"DB request error: "+r);o.event=t,n(o)}}function v(e){return function(n,t){n?e(n):e(null,t.target.result)}}var d,g=["setItem","getItem","hasItem","removeItem","getKeys","getLength","clear"],m=["dbName","storeName","defaultType"],p="db",y="ls",h="auto",I="readwrite",b="readonly",w="[kv-keeper] ",E=Object.keys,N={},K=[];n?d=n:e.KvKeeper=d={},r(),d.preconnect=function(){d.getStorage(t)},d.addErrorListener=function(e){if("function"!=typeof e)throw new Error("Listener must be a function");K.push(e)},d.removeErrorListener=function(e){var n=K.indexOf(e);n>-1&&K.splice(n,1)},d.getErrorListeners=function(){return K},d.removeAllErrorListeners=function(){K=[]},d.configure=function(e){if(d.__configured)throw new Error(w+"Configuration can be set only once");d.__configured=!0,"defaultType"in e&&u(e.defaultType);for(var n in e)if(e.hasOwnProperty(n)){if(!(m.indexOf(n)>-1))throw r(),new Error(w+n+" is not configurable");d[n]=e[n]}d.namespace=o()},d.getStorage=function(e,n){var t=e,r=n;"function"==typeof t&&(r=e,t=null),r=i(r),t=t||d.defaultType,u(t),d._getInstance(t,r)},d._getInstance=function(e,n){var t=N[e];if(t)return n(null,t);var r=w+(e==h?"No supported storages":'No "'+e+'" storage support');if(null===t)return n(new Error(r));var o=a(e);return o&&o.instance?(t=N[e]=o.instance,void t.init(n)):n(new Error(r))},g.forEach(function(e){d[e]=function(){for(var n=[],t=0;t<arguments.length;t++)n.push(arguments[t]);d.getStorage(function(t,r){if(t){var o=n[n.length-1];return o(t)}r[e].apply(r,n)})}});var S=d.StorageLS=function(e){var n=this;n.init=function(e){e(null,n)},n.setItem=function(n,t,r){var o=i(r);try{e.setItem(S.createKey(n),t),o(null)}catch(e){o(e)}},n.getItem=function(n,t){t(null,e.getItem(S.createKey(n)))},n.hasItem=function(n,t){t(null,null!==e.getItem(S.createKey(n)))},n.removeItem=function(n,r){var o=r||t;e.removeItem(S.createKey(n)),o(null)},n.getKeys=function(n){for(var t=E(e),r=d.namespace.length,o=[],u=0;u<t.length;u++){var i=t[u];k(i)&&o.push(i.slice(r))}n(null,o)},n.getLength=function(n){n(null,E(e).filter(k).length)},n.clear=function(n){E(e).filter(k).forEach(e.removeItem,e),n(null)},n.close=function(){delete N.ls,delete N.auto}};S.createKey=function(e){return d.namespace+e};var k=S.isKeeperKey=function(e){return 0==e.indexOf(d.namespace)};S.create=function(){var n=e.localStorage;return n?new S(n):null};var L=d.StorageDB=function(e){function n(e){return t.transaction([d.storeName],e).objectStore(d.storeName)}var t,r=this;r.init=function(n){var o=i(n);l(e,function(e,n){return e?o(e):(t=n,void o(null,r))})},r.close=function(){t&&t.close(),delete N.db,delete N.auto},r.setItem=function(e,t,r){var o=i(r);s(n(I).put({key:e,value:String(t)}),v(o))},r.getItem=function(e,t){var r=i(t);s(n(b).get(e),function(e,n){if(e)return r(e);var t=n.target.result;r(null,t?t.value:null)})},r.hasItem=function(e,t){var r=i(t);s(n(b).get(e),function(e,n){return e?r(e):void r(null,Boolean(n.target.result))})},r.removeItem=function(e,t){var r=i(t);s(n(I).delete(e),v(function(e,n){setTimeout(r.bind(null,e,n),0)}))},r.getKeys=function(e){var t=i(e),r=[];s(n(b).openCursor(),function(e,n){if(e)return t(e);var o=n.target.result;return o?(r.push(o.key),o.continue()):void t(null,r)})},r.getLength=function(e){var t=i(e);s(n(b).count(),v(t))},r.clear=function(e){var t=i(e);s(n(I).clear(),v(t))}};L.create=function(){var n=e.indexedDB;return n&&n.open&&e.IDBKeyRange?new L(n):null},L.setupSchema=function(e){e.objectStoreNames.contains(d.storeName)||e.createObjectStore(d.storeName,{keyPath:"key"})}}(self,"undefined"!=typeof exports&&exports);
//# sourceMappingURL=kv-keeper.map