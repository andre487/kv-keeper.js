// Key-Value Keeper by andre487, see https://clck.ru/9cB92
!function(i,s){function p(){e.dbVersion=1,e.dbName="kv-keeper-items",e.storeName="items",e.defaultType="auto",e.namespace=v()}function v(){return e.dbName+":"+e.storeName+":"}function f(e){if(-1===y.indexOf(e))throw new Error("[kv-keeper] Invalid type "+e)}function d(e){switch(e){case"auto":return k();case"db":return u("db",r.create());case"ls":return u("ls",n.create())}return null}function u(e,n){return{type:e,instance:n}}function k(){var e=o.db;return e?u("db",e):(e=r.create())?u("db",e):(e=o.ls,e?u("ls",e):u("db",n.create()))}function g(o,t){var n=o.open(e.dbName,e.dbVersion);n.onsuccess=function(n){var e=n.target.result;e.onversionchange=function(){e.close()},t(null,e)},n.onerror=function(n){var e=new Error("[kv-keeper] DB request error");e.event=n,t(e)},n.onupgradeneeded=function(e){r.setupSchema(e.target.result)},n.onblocked=function(n){var e=new Error("[kv-keeper] DB is blocked");e.event=n,t(e)}}function t(e,n){e.onsuccess=function(e){n(null,e)},e.onerror=function(t){var e=new Error("[kv-keeper] DB request error");e.event=t,n(e)}}function a(e,n){return e?function(u,a){if(u)return e(u);if(n===s)return e(null);for(var o=n.split("."),t=a,r=0;r<o.length;r++){if(!(o[r]in t)){t=null;break}t=t[o[r]]}e(null,t)}:function(){}}var e,l="readwrite",c="readonly",o={};"undefined"!=typeof exports?e=exports:i.KvKeeper=e={},p();var m=["dbName","storeName","defaultType"];e.configure=function(n){if(e.__configured)throw new Error("[kv-keeper] Configuration can be set only once");e.__configured=!0,"defaultType"in n&&f(n.defaultType),Object.keys(n).forEach(function(t){if(!(m.indexOf(t)>-1))throw p(),new Error("[kv-keeper] Option "+t+" is not configurable");e[t]=n[t]}),e.namespace=v()};var y=["ls","db","auto"];e.getStorage=function(n,t){"function"==typeof n&&(t=n,n=null),n=n||e.defaultType,f(n);var r=e._getInstance(n);if(r)r.init(t);else{var o="auto"===n?"This platform does not support any storages":'Storage with type "'+n+'" is not supported';t(new Error("[kv-keeper] "+o))}},e._getInstance=function(n){var e=o[n];if(!e){var t=d(n);e=o[t.type]=t.instance}return e};var h=["setItem","getItem","hasItem","removeItem","getKeys","getLength","clear"];h.forEach(function(n){e[n]=function(){var t=[];[].push.apply(t,arguments),e.getStorage(function(e,r){if(e){var o=t[t.length-1];return o(e)}r[n].apply(r,t)})}});var n=e.StorageLS=function(t){var e=this;e.init=function(n){n(null,e)},e.setItem=function(r,o,e){r=n.createKey(r);try{t.setItem(r,o),e&&e(null)}catch(n){e&&e(n)}},e.getItem=function(e,r){e=n.createKey(e),r(null,t.getItem(e))},e.hasItem=function(e,r){e=n.createKey(e),r(null,t[e]!==s)},e.removeItem=function(e,r){e=n.createKey(e),t.removeItem(e),r&&r(null)},e.getKeys=function(e){var r=Object.keys(t).filter(n.isKeeperKey);e(null,r)},e.getLength=function(e){e(null,t.length)},e.clear=function(e){t.clear(),e&&e(null)},e.close=function(){o.ls=null}};n.createKey=function(n){return e.namespace+n},n.isKeeperKey=function(n){return 0===n.indexOf(e.namespace)},n.create=function(){var e=i.localStorage;return e?new n(e):null};var r=e.StorageDB=function(i){function r(n){return u.transaction([e.storeName],n).objectStore(e.storeName)}var u,n=this;n.init=function(e){g(i,function(t,r){return t?e(t):(u=r,void e(null,n))})},n.close=function(){u.close(),o.db=null},n.setItem=function(e,n,o){var u=r(l).put({key:e,value:n});t(u,a(o))},n.getItem=function(e,n){var o=r(c).get(e);t(o,a(n,"target.result.value"))},n.hasItem=function(n,e){var o=r(c).openCursor(n);t(o,function(n,t){return n?e(n):void e(null,Boolean(t.target.result))})},n.removeItem=function(e,n){function o(){var e=arguments;setTimeout(function(){n.apply(null,e)},0)}var u=r(l).delete(e);t(u,a(o))},n.getKeys=function(e){var o=r(c).openCursor(),n=[];t(o,function(r,o){if(r)return e(r);var t=o.target.result;return t?(n.push(t.key),t.continue()):void e(null,n)})},n.getLength=function(e){var n=r(c).count();t(n,a(e,"target.result"))},n.clear=function(e){var n=r(l).clear();t(n,a(e))}};r.create=function(){var e=i.indexedDB;return e?new r(e):null},r.setupSchema=function(n){try{n.createObjectStore(e.storeName,{keyPath:"key"})}catch(e){if("ConstraintError"!==e.name)throw e;console.warn("[kv-keeper] data store already exists")}}}(self);
//# sourceMappingURL=kv-keeper.map